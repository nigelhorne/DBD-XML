#!/usr/bin/env perl

use warnings;
use strict;
use autodie qw(:all);

use Data::Dumper;

use FindBin qw($Bin);
use lib "$Bin/../lib";
use DBD::XML;

print "Test 1 - import from file\n";
my $dbh = DBI->connect('dbi:XML(RaiseError => 1):');

# To be replaces with xml_import one the driver has been registered
# print "ad_import file\n";
$dbh->func('person', 'XML', "$Bin/../data/person.xml", 'ad_import');

# print "prepare\n";
# my $sth = $dbh->prepare( "SELECT * FROM person WHERE name = 'Nigel Horne'");
# my $sth = $dbh->prepare( "SELECT * FROM person WHERE email = 'njh\@bandsman.co.uk'");
my $sth = $dbh->prepare("SELECT * FROM person");
# my $sth = $dbh->prepare( "SELECT name FROM person WHERE email = 'njh\@bandsman.co.uk'");
# print "execute\n";
$sth->execute();

# print "getting first row\n";
while (my $href = $sth->fetchrow_hashref()) {
	my $d = Data::Dumper->new([$href]);
	print "got data:\n", $d->Dump();
}

print "Test 2 - import from string\n";
$dbh = DBI->connect('dbi:XML(RaiseError => 1):');
# print "ad_import string\n";
$dbh->func('person2', 'XML', [<DATA>], 'ad_import');

# $sth = $dbh->prepare("SELECT * FROM person2");
$sth = $dbh->prepare("Select email FROM person2 WHERE name = 'Nigel Horne'");
# print "execute\n";
$sth->execute();

# print "getting first row\n";
while (my $href = $sth->fetchrow_hashref()) {
	my $d = Data::Dumper->new([$href]);
	print "got data:\n", $d->Dump();
}

__DATA__
<?xml version="1.0" encoding="US-ASCII"?>
<table>
	<row id="1">
		<name>Nigel Horne</name>
		<email>njh@concert-bands.co.uk</email>
	</row>
	<row id="2">
		<name>A N Other</name>
		<email>somebody@example.com</email>
	</row>
</table>
